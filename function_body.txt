
BEGIN
  IF NEW.status = 'posted' AND (TG_OP = 'INSERT' OR OLD.status != 'posted') THEN
    -- Update debit account (increase for asset/expense, decrease for liability/equity/revenue)
    UPDATE public.ledger_accounts
    SET balance = balance + NEW.amount
    WHERE id = NEW.debit_account_id;
    
    -- Update credit account (decrease for asset/expense, increase for liability/equity/revenue)
    UPDATE public.ledger_accounts
    SET balance = balance - NEW.amount
    WHERE id = NEW.credit_account_id;
  ELSIF OLD.status = 'posted' AND NEW.status = 'reversed' THEN
    -- Reverse the entry
    UPDATE public.ledger_accounts
    SET balance = balance - NEW.amount
    WHERE id = NEW.debit_account_id;
    
    UPDATE public.ledger_accounts
    SET balance = balance + NEW.amount
    WHERE id = NEW.credit_account_id;
  END IF;
  
  RETURN NEW;
END;
